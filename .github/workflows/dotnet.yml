# name: .NET

# on:
#   push:
#     branches: [ master ]
#   pull_request:
#     branches: [ master ]

# jobs:
#   build:

#     runs-on: ubuntu-latest

#     steps:
#     - 
#       uses: actions/checkout@v3
#     - 
#       name: Setup .NET
#       uses: actions/setup-dotnet@v2
#       with:
#         dotnet-version: 6.0.x
#     - 
#       name: Restore dependencies
#       run: dotnet restore
#     - 
#       name: Build
#       run: dotnet build --no-restore
#     - 
#       name: Test
#       run: dotnet test --no-build --verbosity normal
#     - 
#       name: publish on version change
#       id: publish_nuget
#       uses: rohith/publish-nuget@v2
#       with:
#         # Filepath of the project to be packaged, relative to root of repository
#         PROJECT_FILE_PATH: StringSwitch.Net/StringSwitch.Net.csproj
        
#         # NuGet package id, used for version detection & defaults to project name
#         PACKAGE_NAME: StringSwitch.Net
        
#         # Filepath with version info, relative to root of repository & defaults to PROJECT_FILE_PATH
#         # VERSION_FILE_PATH: Directory.Build.props
    
#         # Regex pattern to extract version info in a capturing group
#         # VERSION_REGEX: ^\s*<Version>(.*)<\/Version>\s*$
        
#         # Useful with external providers like Nerdbank.GitVersioning, ignores VERSION_FILE_PATH & VERSION_REGEX
#         # VERSION_STATIC: 1.0.0
    
#         # Flag to toggle git tagging, enabled by default
#         # TAG_COMMIT: true
    
#         # Format of the git tag, [*] gets replaced with actual version
#         # TAG_FORMAT: v*
    
#         # API key to authenticate with NuGet server
#         NUGET_KEY: ${{secrets.NUGET_API_KEY}}
    
#         # NuGet server uri hosting the packages, defaults to https://api.nuget.org
#         # NUGET_SOURCE: https://api.nuget.org
    
#         # Flag to toggle pushing symbols along with nuget package to the server, disabled by default
#         # INCLUDE_SYMBOLS: false


name: CI

on:
  create:
    branches: 
      - release/**
  push:
    branches:
    - master
    - release/**
  pull_request:
    branches:
    - master
    
jobs:
  build:

    env:
      BUILD_CONFIG: 'Release'
      SOLUTION: 'StringSwitch.Net.sln'

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    
    - name: Get Build Version
      run: |
        $VERSION="1.0.${{github.run_number}}"
        echo "BUILD_VERSION=$VERSION"
        echo "BUILD_VERSION=$VERSION" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf-8 -Append
        
      shell: pwsh

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1.0.5

    - name: Restore dependencies
      run: nuget restore $SOLUTION

    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x

    - name: Build
      run: dotnet build $SOLUTION --configuration $BUILD_CONFIG -p:Version=$BUILD_VERSION --no-restore

    - name: Run tests
      run: dotnet test /p:Configuration=$BUILD_CONFIG --no-restore --no-build --verbosity normal
      
    - name: Publish
      if: startsWith(github.ref, 'refs/heads/release')
      run: nuget push **\*.nupkg -Source 'https://api.nuget.org/v3/index.json' -ApiKey ${{secrets.NUGET_API_KEY}}